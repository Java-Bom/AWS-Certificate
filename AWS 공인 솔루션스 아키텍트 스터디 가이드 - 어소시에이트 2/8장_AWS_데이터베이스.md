# AWS 데이터베이스

## RDS

### 장점

- 인프라 관리 불필요
- 즉각적인 프로비저닝
- 확장성 관리
  - 스케일 업/다운
- 비용 효율성
  - 사용량만큼 비용 부담
- 애플리케이션 호환성
- 고가용성
  - 멀티 AZ 환경에서 프로비저닝하고 동기적으로 다른 AZ의 대기 인스턴스에 복제
- 보안유지
  - 대기상태 데이터, 이동상태 데이터 모두 암호화 지원
  - KMS로 암호화

### 데이터 베이스 호스팅

#### RDS 추천

- 비즈니스에만 집중
- 데이터베이스 관리업무 x
- 하이레벨 튜닝, 스키마 최적화의 업무만
- 관리역량 부족
- 다중 AZ 복제환경
- 백업 및 복원 자동화

#### EC2 추천

- 데이터베이스의 완전한 통제권
- 운영체제 시스템의 통제권
- 백업, 복제, 클러스터링의 통제권
- 기업의 RDBMS엔진의 주요기능이 RDS와 안맞는 경우
- 용량, 성능이 RDS 제공 수준을 넘어서는 경우

### 고가용성 구현

- HA환경 설정이 필요하다

#### 싱글 AZ 배포

- 경험차원의 사용 용도

#### 멀티 AZ 배포

- 데이터를 잃어버려선 안되는 경우
- 복원 소요시간이 촉박한 경우
- 가동정지 시간이 허용되지 않아야 하는 경우

##### 구조

- 마스터 데이터베이스가 트래픽 처리
- 스탠바이 데이터베이스는 셧다운 대비용으로 가동가능상태에서 대기
- 대기 데이터베이스에 트래픽 분산은 불가능, 액티브 / 패시브 모델과 비슷
- 데이터는 동기적으로 대기 데이터베이스에 복제

##### 기능

- 데이터 손실 가능성이 없다
- 장애 발생시 대기 데이터 베이스가 격상하고 트래픽을 받는다
  - 따로 데이터베이스를 연결하는 작업은 할 필요 없다
  - 자동으로 DNS 장애대응 기능을 활성화 한다

### 확장성 구현

#### 인스턴스 타입 변경

- 가장 간단한 방법은 인스턴스 타입변경
  - 클래스 변경에 따라 약간의 가동 정지시간이 발생할 수 있다.
    - 반드시 클래스별 확인 필요
  - 크론잡으로도 처리 가능
  - CloudWatch, SNS, Lambda로도 가능

#### 읽기 사본 활용

- read-only 트래픽의 부담을 줄일 수 있다.
- 해당 국가의 리전에 읽기 사본을 둬서 성능 향상
  - 크로스 리전 읽기 사본
    - 일부 RDBMS는 미지원
- 읽기 사본이 장애시 승격

### 보안성 구현

#### VPC, RDS

- VPC내에 런칭된다.
- 프라이빗 서브넷에 두도록 하라
- SG를 이용하여 트래픽 차단/허용 가능

##### 연결방식

- VPC내 데이터 센터를 VPN과 연결하여 하이브리드 방식으로 연결
- Direct Connect로 데이터 센터와 AWS 리전을 연결
- 두개의 VPC를 피어링하여 어플리케이션, RDS를 분리 연결
- VPC에 igw를 붙여 퍼블릭하게 접근
- 서브넷의 라우트 테이블을 이용하여 라우팅 방식 정의

##### 데이터 암호화

- 데이터베이스 인스턴스 스토리지 암호화
- 자동화된 백업 암호화
- 마스터 데이터베이스의 읽기 사본 암호화
- 마스터 데이터베이스의 스탠바이 데이터베이스 암호화
- 데이터베이스로 생성한 스냅샷 암호화
- 암호화 방식은 RDS, TDE가 있는데 하나만 선택해야 성능저하가 발생하지 않는다

##### 암호화 방식

- KMS가 RDS를 위한 기본키 생성하여 인스턴스의 데이터 암호화 복호화에 사용 (AES-256)
- 사용자 자체 생성키로 암호화 관리 가능
- 계층 구조
  - RDS 데이터 키 : RDS 내 테이터 암호화
  - AWS KMS 마스터 키 : 데이터 키 암호화

##### 주의사항

- 데이터베이스 생성시에만 암호화 진행가능, 선택시 인스턴스를 끌 수 없다. 암호화가 필요없다면 새 인스턴스 생성하여 옮겨야한다
- 마스터, 읽기 사본은 반드시 암호화 해야한다.
- 다른 AWS 리전으로 암호화 데이터베이스를 복사 불가능하다.
  - KMS가 리전별 서비스라서
- MySQL 암호화 데이터베이스를 Aurora MySQL로 마이그레이션 가능

### 백업, 복구, 스냅샷

- Aurora 제외 모든 엔진은 하루 한번의 백업 실시
  - 일정 조절 가능
  - 모니터링 가능
  - 대상
    - 전체 데이터베이스
    - 전체 로그
    - 변경 로드
  - 보존기간 35일
    - 티켓으로 증가 가능
  - 배포한 AZ마다 존재
- S3에 저장하며 수동 저장 가능
- 백업으로 새 복사본 생성, 기본 데이터 베이스 복제 가능
  - 복원 장소
  - 복원시기 선택
    - 복원 가능 마지막 시점
    - 커스텀 시점
- 스냅샷은 사용자가 직접 생성
  - 생성시 수초, 수분간 임시 IO 처리능력 제공
  - S3에 생성
  - 용도
    - 비상용
    - 버그테스트
    - 재난복구용
    - 다수의 계정에 복제 등..

### 모니터링

- CloudWatch로 전송하여 확인
- 종류
  - 표준 모니터링
    - 1분간격 확인 가능
    - CPU
    - 스토리지
    - 메모리
    - 스왑 사용량
    - 데이터베이스 커넥션
    - I/O
    - 지연
    - 처리성능
    - 읽기사본
    - 처리지연
  - 강화 모니터링
    - 1초간격
    - 표쥰보다 37개 더 확인 가능
  - 이벤트 노티피케이션
    - SNS로 노티피케이션 전송
    - 이벤트
      - 가용성
      - 백업
      - 환경설정변경
      - 생성
      - 삭제
      - 실패
      - 장애대응
      - 유지보수
      - 복수
      - 복원
  - 퍼포먼스 인사이트
    - 지난 15분
      - 60분까지 가능
    - 성능 영향요소 시각화

### Aurora

- MySQL, PostgreSQL 호환 관계형 데이터베이스
- 세개의 서로 다른 AZ에 여섯개의 서로 다른 스토리지 노트로 분리된 스토리지 레이어에 자동으로 복제
  - 별도의 비용없음
  - 동기적으로 데이터 미러링
  - 쿼럼 시스템으로 데이터 가용성 보장
  - 모든 데이터를 S3에 지속적으로 백업
  - 스토리지 볼륨은 64TB로 증가
- 최대 15개 읽기 사본 지원
- 스토리지 레벨에서 데이터 복제
  - 동기적으로 데이터 복제
  - 스탠바이 개념 없이 마스터 장애시 읽기 사본이 승격
- MySQL 보다 평균 5배 좋음

### Redshift

- 관리형 데이터 웨어하우스 솔루션
  - 웨어하우스를 이용하여 트랜잭션 워크로드와 분석 워크로드를 분리 처리
  - 트랜잭션 시스템에 영향을 주지 않고 분석업무를 높은성능으로 처리
- 데이터 처리, 분석 성능 강화용
- 데이터 쿼리, 분석에 초점
- aka. 온라인 분석 처리 시스템 OLAP
  - 배치 프로세스, 스케쥴 잡으로 막대한 양을 효과적으로 수집

#### 장점

- 신속성
  - 칼럼형 스토리지
  - 병렬적으로 여러노드에서 동시에 처리
- 저렴함
- 우수한 압축성
- 관리형 서비스
- 확자성
  - 수평적 확장/축소 가능
- 보안성
  - 저장중, 이동중 데이터 암호화 가능
  - KMS, HSM으로 키 관리
- 존 맵 기능
  - 일종의 필터링 기능
  - 불필요한 IO 최소화

#### 아키텍쳐

- 리더노드
  - 1개
  - SQL 엔드포인트
  - 기능, 병렬적 SQL 처리 업무 조정 역할
- 컴퓨트 노드
  - N개 (최대 128개)
  - 실제로 쿼리로 데이터 처리
  - 쿼리 처리시 컴퓨트 노드간 소통
  - 클라이언트는 컴퓨트와 직접소통 불가능
    - 컴퓨트 노드는 S3와 통신은 가능
  - 여러개의 조각 또는 파티션으로 나눌수 있다
    - CPU
    - 메모리
    - 스토리지

#### 처리 순서

1. 클라이언트가 쿼리 제출
2. 리더노드가 쿼리 파싱, 수행계획 수립
3. 컴퓨트 노드를 선정, 쿼리 잡을 배분
4. 컴퓨트 노드가 잡 처리후 결과를 리더에게 전달
5. 리더가 결과 취합후 클라이언트에게 전달

#### 클러스터 타입

- 싱글 노드
  - 리더 노드, 컴퓨트 노드를 하나의 노드가 다함
  - 테스트, 개발용
- 멀티 노드
  - 리더와 컴퓨트 분리
  - 클러스터별로 하나의 리더 존재
  - 컴퓨트 다운시 자동으로 다른 컴퓨트 노드가 대체
- 선택가능 인스턴스 타입
  - RA3 고 SSD 및 RMS
    - 추천
  - SSD 기반 덴스 컴퓨트
  - HDD기반 덴스 스토리지
    - 비추천

- Redshift Spectrum을 이용하여 S3에 존재하는 데이터를 쿼리 가능하고 Redshift 클러스터에 존재하는 데이터 쿼리 가능

#### 클러스터 크기 조절

- 데이터 미러링 기능은 이미 포함되어있어 별도 작업이 필요없다

#### 네트워킹

- VPC내에서 실행
  - EC2-Classic은 불가능
- 프라이빗, 퍼블릭 서브넷 모두 가능
- 그런데 컴퓨트 노드는 별도의 VPC에 생성되서 접근할수가 없다
- 강화 VPC 라우팅 옵션
  - 트래픽 명령 용시 데이터 트래픽이 VPC를 거쳐 라우팅
  - 트래픽 흐름 관리 가능
  - 미적용시 인터넷을 통해 라우팅
- 기본적으로 EC2-VPC 플랫폼만 사용 가능

#### 암호화

- 클러스터의 모든 데이터 암호화 가능
  - 이동중
  - 저장중
    - AES-256
      - 데이터 블록
      - 클러스터 시스템 메타데이터
    - KMS, HSM 으로 관리 가능
- 암호화는 수정 불가능
- 런칭시 옵션 선택
  - 없이 시작하면 계속 없이 써야함
    - 없는걸 활성화 하려면 데이터 언로드 한다음 암호화된 클러스터에 리로드 해야함

#### 보안

- 슈퍼유저, 유저퍼미션을 지닌 데이터베이스 유저 생성
- 마스터유저(슈퍼유저)는 삭제 불가능

#### 백업 및 복구

- 스냅샷 형태로 자동화된 백업 생성
  - S3에 저장
  - 조건
    - 8시간마다
    - 5GB 추가마다
  - 자동기능 끌 수 있다
- 복구시점 목표에 따라 생성도 가능
- 보존 기간 정의 가능
- 원하시는 시점에 생성 가능
- 다른리전에 복사 가능
  - 크로스 리전 스냅샷 기능

#### 데이터 로딩하기

TODO 정리

#### 데이터 배분 전략

TODO 정리

### DynamoDB

- 고성능의 완전 관리형 NoSQL 데이터베이스
- 도큐먼트 구조, 키 밸류 데이터 구조
- 완전관리형이라 테이블 생성시 애플리케이션에 요구되는 처리용량 지정만 하면된다.

#### 장점

- 확장성
  - 자동 스케일 업/다운
    - with CloudWatch
- 관리형 서비스
- 신속성, 일관된 성능
  - 자동으로 데이터 파티셔닝
- 세분화된 접근 제어
- 비용 효율성
  - 사용량, 프로비저닝 IO 처리성능 비용
- 다른 AWS 서비스와 통합
  - 람다와 통합

#### 주요 개념 및 용어

- 행 개념 없음
- 기본키와 속성 쌍으로 이루어짐
- 스키마가 없음
- 데이터 아이템이 동일한 규격일 필요없음
- 기본키
  - 스칼라 값
  - 서로 구분될 수 있는 속성
  - 단일속성
    - 파티션 키
      - 단순 기본키
      - 하나의 테이블에 하나의 파티션 키가 존재
  - 복합속성
    - 파티션키+정렬키
      - 정렬키 순으로 정렬
- 아이템
  - 키 + 속성
  - 합산 용량 400KB초과 x
- 속성
  - 하나의 값 혹은 값의 집합
- DML 언어 제공하지 않음
- 객체지향언어로 처리가능
- 데이터 타입
  - NULL
  - 스칼라
    - Number
    - String
    - Binary
    - Boolean
  - 콜렉션
    - Number set
    - String set
    - Binary set
    - 비동질적 List, Map

- 쓰기 용량 유닛은 아이템당 초당 최대 1KB
- 읽기 용량 초당 최대 4KB

#### 보조 인덱스

- 파티션키, 파티션 정렬키를 포함한 인덱스
- 종류
  - 지역보조 인덱스
    - 파티션키는 같지만 정렬키가 다르다
  - 전역보조 인덱스
    - 파티션 키 및 파티션 정렬키가 모두 다르다

#### 일관성 모델

- 테이블 마다 세 개의 다른 지역에 사본을 분산 저장
  - 고가용성
  - 고신뢰성
- 종류
  - 최종적 일관성
    - 최근 완료된 쓰기 결과를 반영하지 못할 수 있음
  - 강한 일관성의 읽기
    - 일긱 요청에 대해 언제라도 최신의 쓰기 결과 반환

#### 글로벌 테이블

- 관리형 멀티 리전, 멀티 마스터 데이터 베이스 지원
  - 테이블 자동 복제하여 크로스 리전 환경 구현
  - 리전환경 데이터 중복 구현으로 리전별 재해에서 가용성 유지
  - 모든 AWS 리전에 시간순으로 변경내역 전파

#### DynamoDB Streams

- DynamoDB Streams API를 이용해 최신 데이터를 가져오거나 아이템 레벨의 데이터를 확할 수 있다.
- 응용 어플리케이션 구현에 활용
- 멀티 마스터 데이터베이스 구조 구현
  - 각 마스터가 동기화 상태를 유지하게
- Redshift같은 웨어하우스 도구를 이용하여 모든 변경내역을 동기화해 실시간 분석
- DynamoDB Logstash 플러그인으로 ElasticSearch를 통합 하여 프리텍스트 서치 기능 제공 가능

#### DynamoDB Accelerator

- 인메모리 캐시 서비스로 10배 높은 성능 제공
- 어플리케이션 로직 수정 불필요

#### 암호화 및 보안

- 저장 상태 데이터에 대한 암호화 기능 제공
  - KMS 이용

### ElasticCache

- 클라우드에서 인메모리 캐시 배포, 운영, 확장
- 애플리케이션에 인메모리 캐시 레이어 추가 가능
  - EC2
  - RDS
  - CloudFormation
  - Elastic Beanstalk
  - OpsWorks
- 샤딩 기법으로 메모리 확장성 관리
- 다수의 사본으로 성능 향상
- 키-밸류 엔진 종류
  - Memcached
    - 별도의 계층이기때문에 데이터베이스와 직접 소통하지 않고 데이터베이스 정보를 지니지 않음
  - Redis
    - 장애대응 기능을 포함한 스테이트풀 개체
- 최고의 성능을 위해 애플리케이션 서버가 있는 AZ와 클러스터를 함께 둔다
  - Preferred Zone 옵션을 설정한다

### Neptune

- 완전 관리형 그래프 데이터베이스 서비스
- 모델 종류
  - Property Graph
  - Resource Description Framework

#### 장점

- 완전관리형
- 확장성
- 고가용성 및 내오류성
- ACID 조건 충족
- 보안성

#### 활용 전략

- 소셜 네트워크
- 추천 시스템
- 지식 그래프
- 네트워크/IT 운영 및 데이터 센터
- 생명과학
- 경로 최적화
- 사기행위 분석

### DocumentDB

- MongoDB 워크로드 처리용 완전관리형 데이터 베이스
- 반구조화 데이터 저장용
- 키-밸류 쌍
  - 정규화 되지 않는다

#### 장점

- 고가용성
- 고성능
- 고도의 보안성
- 완전 관리형

#### 활용 전략

- 사용자 프로필 관리
- 실시간 빅데이터 처리
- 콘텐트 관리
- 모바일 및 웹 애플리케이션
