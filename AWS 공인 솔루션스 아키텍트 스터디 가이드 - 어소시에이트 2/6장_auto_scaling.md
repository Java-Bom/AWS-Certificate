### 6장 Auto Scaling

> 온프라미스 중심의 인프라를 운영할 시 불규칙적인 트래픽을 관리하기 위해 충분한 리소스를 미리 확보해야한다
>
> 이 경우 과잉 프로비전이 발생해 비용낭비로 이어질 수 있다
>
> Auto Scaling은 미리 정해 놓은 규칙에 따라 워크로드를 자동으로 확대/축소 하므로 트래픽 별 적절한 리소스 사용을 유도해 비용절감의 효과를 가질 수 있다.



- Auto scaling 장점

  - 동적 스케일링
  - 최상의 사용자 경험 및 성능 향상
    - Cpu 수준/ 애플리케이션 상태를 항상 최상의 상태로 제공가능
  - 헬스 체크와 서버 플릿 관리
  - 로드 벨런싱
  - 타깃 트래킹
    - 설정한 타깃에 맞춰 ec2 인스턴스의 수를 조정한다
  - 리소스 비용 관리
  - 예측적 확장
    - 머신러닝을 활용한 예측 확장 가능

- Auto scaling 가능 서비스

  - ec2 스팟 인스턴스
  - ecs
  - emr
    - 빅 데이터 프레임워크 실행을 간소화하는 관리형 클러스터 플랫폼
  - appStream 2.0 인스턴스
    - 사용자가 어디서나 데스크톱 애플리케이션에 즉시 액세스할 수 있는 완전 관리형 애플리케이션 스트리밍 서비스
  - Aurora Replicas
  - Dynamo

- 확장 가능 리소스 파악방법

  - CloudFormation 스택을 통한 검색
    - 자동화된 스케일링 환경 설정이 가능한 리소스를 검색
  - 태그를 기준으로 한 검색
    - 확장 가능한 리소스에 태그를 추가하는 경우 애플리케이션별 로 다양한 리소스 세트에 대해 크기 조정 계획을 설정할 수 있다
  - ec2 asg

- 리소스 확장 전략 구체화

  - 가용성 기준 최적화
    - Cpu 40
  - 가용성과 비용의 균형
    - cpu 50
  - 비용 기준 최적화
    - Cpu 70
  - 커스텀 스케일링 전략

- ec2 auto scaling 활용

  - Launch Configuration/Launch Template을 활용해서 어떤 서버를 사용할지 결정한다

- asg 그룹

  - 인스턴스 레벨 유지
    - 항상 실행 상태를 유지하고자 하는 인스턴스의 수를 정의
  - 수동 스케일링
  - 요구별 스케일링
    - Cpu/디스크 쓰기와 읽기/ 네트워크 유입과 유출등 주요 지표로 스케일링 큐칙을 정하는 방식
  - 일정별 스케일링
    - 특정 시간대에 따라 스케일링 정책 설정
  - SNS 알림을 통해 asg에게 스케일업 또는 스케일 다운 시기를 알려줄 수 있다

- 스케일링 유형

  - 심플 스케일링
    - 단하나의 스케일링 정책 사용
    - ex) cpu 사용양
  - 단계별 심플 스케일링
    - ex) cpu 50%에는 2대 60% 에는 4대
    - 심플 스케일링 활용시 처리용량
      - 정확한 용량 - 현재 - 2 /조정 용량-4/ 스케일업-4
      - 숫자 지정 용량 - 현재 - 2 /조정 용량-4/ 스케일업-6
      - 퍼센트 단위의 용량 변경 - 10/ 조정용량-20%/ 스케일업 - 12
  - 타깃 트래킹 스케일링 정책
    - Cpu 용량을 40프로로 유지하도록 인스턴스 수를 유지한다

- 인스턴스 삭제 정책

  - 인스턴스는 삭제시 가장 오랫동안 실행된 서버/ 시간단위 과금이 임박한 서버/LaunchTemplate이 가장 오래된 버전을 삭제한다

- elb장점

  - 통합성 - 다양한 aws 서비스와 통합가능 
  - 안전성 - 통합 인증/ssl 복호화/ 포트 포워딩
  - 고가용성 - 다수의 az에 배포된 ec2 트래픽 분산 가능
  - 저렴함 

- elb 작동방식

  - elb 인스턴스는 다중 az 환경에 구현돼 있으며 사용자가 다중 az 환경에 애플리케이션 또는 워크로드를 배포하지 않아도 로드 밸런서는 기본적으로 다중 az 환경에 배포한다
  - elb 관련 모든 업무를 자동처리하며 별도 비용 부과하지 않는다

- 로드벨러서 유형

  - nlb
    - osi 모델 레이어 4에서 동작
    - ec2 인스턴스, 컨테이너, ip 주소등의 연결을 관리한다
    - xff헤더가 없으므로 프록시 프로토콜이 소스 ip 주소를 관리
    - Tcp/ssl 모두 지원
  - alb
    - http/https 지원
    - xff 헤더에 클라이언트 ip 주소 관리
    - 콘텐트 기반 라우팅 가능(host/path)
  - clb
    - 레이어 4/http/https 지원
    - 클래식 ec2가 아니라면 nlb/alb 사용하는것을 권장

- 로드벨런서 핵심 용어

  - 리스너
    - 트래픽을 처리하기 위해 최소 하나 이상의 리스너가 필요하다
    - 경로기반 라우팅 규칙은 리스너에 정의한다
  - 타깃 그룹과 타깃
    - 논리적인 그룹화
    - 리전단위
  - 규칙
    - 리스너와 타깃그룹을 연결해주며 조건과 동작으로 구성된다
  - 헬스체크
    - initial - 헬스체크 수행중
    - healthy - 타킷 정상
    - unhealthy - 헬스체크 실패
    - unused - 타깃이 타깃그룹에 등록되지 않않고, 타깃그룹은 로드벨런서의 리스너 규칙에서 사용되지 않았거나, 타깃이 로드밸런서를 사용할 수 없는 az에 존재
    - draining  - 타깃의 드록이 해제됐고 연결 해제 절차가 진행 중
  - 다중 az 활용
    - 다중 az에 구성되어 하나의 az가 다운되더라도 효율적 트래픽 분산가능
    - 동적 스케일링 관리 시 세션정보를 ec2에 저장하면 이슈가 되므로 분리된 환경으로 세션을 관리해야한다
    - 자바기반 어플리케이션은 dns에 있는 서버 ip 주소를 임시 저장하는 이슈가 있을 수 있다
      - 한 인스턴스로 계속요청보냄
      - 크로스 존 로드 벨런싱 기능을 on 할시 해결된다 (alb는 기본 기능)
        - 크로스 존 로드벨런싱 기능은 서로 다른 가용영역의 타깃에 elb 인스턴스 레벨에서 데이터 전송이 가능하다
        - 타깃레벨 로드벨런싱

  

  